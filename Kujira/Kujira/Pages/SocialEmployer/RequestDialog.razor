@using Kujira.Gui.Api.Requests
@using Kujira.Gui.Services
@using MudBlazor
@using Newtonsoft.Json
@using Kujira.Api.Requests
@using Kujira.Gui.Api
@inject ISnackbar Snackbar
@inject IKujiraBackendApi KujiraBackendApi
@inject IDialogService DialogService
@inject AuthenticationService AuthenticationService


<MudDialog>
    <DialogContent>
        <MudTextField T="string" Label="Nachricht" @bind-Value="@requestMessage"/>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@SubmitRequest">Anfrage senden</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private static NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger();

    [Parameter]
    public OfferRequest Offer { get; set; }

    [Parameter]
    public Action OnRequestSent { get; set; }

    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    private string requestMessage;

    private async Task SubmitRequest()
    {
        try
        {
            var loggedInUserId = await AuthenticationService.GetLoggedInUserIdAsync();
            var loggedInUserEmail = await AuthenticationService.GetEmailFromTokenAsync();

            if (loggedInUserId == Guid.Empty)
            {
                Snackbar.Add("Sie sind nicht angemeldet.", Severity.Error);
                return;
            }

            var user = await GetUserByIdAsync(loggedInUserId);
            if (user == null)
            {
                Snackbar.Add("Benutzerdaten konnten nicht abgerufen werden.", Severity.Error);
                return;
            }

            var requestDto = new ServiceRequestRequest
            {
                OfferId = Offer.Id,
                FromUserId = loggedInUserId,
                ToUserId = Offer.UserId,
                Message = requestMessage,
                RequesterFirstName = user.FirstName,
                RequesterLastName = user.LastName,
                RequesterEmail = loggedInUserEmail,
                RequesterPhoneNumber = user.PhoneNumber
            };


            await KujiraBackendApi.SendRequest(requestDto);
            Snackbar.Add("Anfrage erfolgreich gesendet.", Severity.Success);

            OnRequestSent?.Invoke();
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            logger.Info($"Error when sending request: {ex}");
        }
    }

    private async Task<UserRequest> GetUserByIdAsync(Guid userId)
    {
        try
        {
            return await KujiraBackendApi.GetUser(userId);
        }
        catch (Exception ex)
        {
            logger.Info($"Error when get user by id: {ex}");
            return null;
        }
    }

}