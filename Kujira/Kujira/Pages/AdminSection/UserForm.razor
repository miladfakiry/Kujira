@using Kujira.Api
@using Kujira.Api.Requests
@using Kujira.Gui.Api.Requests
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@inject IKujiraBackendApi KujiraBackendApi
@inject ISnackbar Snackbar


<EditForm Model="@userFormModel" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator/>
    <MudGrid>
        <MudItem xs="12">
            <MudCard>
                <MudCardContent>
                    <MudTextField Label="Vorname" @bind-Value="@userFormModel.FirstName" For="@(() => userFormModel.FirstName)" />
                    <MudTextField Label="Nachname" @bind-Value="@userFormModel.LastName" For="@(() => userFormModel.LastName)" />
                    <MudDatePicker Label="Geburtsdatum" Editable="true" @bind-Date="userFormModel.DateOfBirth" Mask="@(new DateMask("dd.MM.yyyy"))" DateFormat="dd.MM.yyyy" />
                    <MudTextField Label="Telefonnummer" @bind-Value="@userFormModel.PhoneNumber" For="@(() => userFormModel.PhoneNumber)" Required="false" />
                    <MudSelect T="CompanyOption" Label="Verwaltung" @bind-Value="selectedCompany">
                        @if (companies != null)
                        {
                            @foreach (var company in companies)
                            {
                                <MudSelectItem Value="new CompanyOption(company.Id, company.Name)" />
                            }
                        }
                        else
                        {
                            <MudSelectItem Value="@(new CompanyOption(Guid.Empty, "Keine Verwaltung verfügbar"))" Disabled />
                        }
                    </MudSelect>
                    <MudTextField Label="E-Mail-Adresse" @bind-Value="@userFormModel.Email" For="@(() => userFormModel.Email)" Validation="@(new EmailAddressAttribute() {ErrorMessage = "Die E-Mail Adresse ist nicht gültig"})" Required="true" />
                    <MudTextField Label="Passwort" @bind-Value="@userFormModel.Password" For="@(() => userFormModel.Password)" InputType="InputType.Password" />
                    <MudSelect T="RoleRequest" Label="Role" @bind-Value="selectedRole" OnOpen="@LoadRoles">
                    @if (roles != null)
                    {
                        @foreach (var role in roles)
                        {
                            <MudSelectItem Value="@role"/>
                        }
                    }
                    else
                    {
                            <MudSelectItem Value="@(new RoleRequest(Guid.Empty, "Keine Role verfügbar"))" Disabled />
                    }
                    </MudSelect>
                </MudCardContent>
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Benutzer erstellen</MudButton>
                </MudCardActions>
            </MudCard>
    </MudItem>
    </MudGrid>
</EditForm>

@code {
    private UserRequest userFormModel = new UserRequest();
    private IEnumerable<CompanyRequest> companies;
    private IEnumerable<RoleRequest> roles;
    private CompanyOption selectedCompany;
    private RoleRequest selectedRole;

    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var companyResponses = await KujiraBackendApi.GetCompanies();
        companies = companyResponses.Select(c => new CompanyRequest { Id = c.Id, Name = c.Name }).ToList();
    }

    private async Task LoadRoles()
    {
        if (roles == null || !roles.Any())
        {
            var roleResponses = await KujiraBackendApi.GetRoles();
            roles = roleResponses.Select(c => new RoleRequest(c.Id, c.Name)).ToList();
        }
    }

    [Parameter]
    public EventCallback<bool> OnUserCreated { get; set; }
    private async Task OnValidSubmit()
    {
        try
        {
            userFormModel.CompanyId = selectedCompany.Id;
            userFormModel.RoleId = selectedRole.Id;
            await KujiraBackendApi.CreateUser(userFormModel);
            Snackbar.Add("Benutzer erfolgreich erstellt", Severity.Success);
            await OnUserCreated.InvokeAsync(true);
            MudDialog.Close(DialogResult.Ok(true));
            
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Erstellen des Benutzers: {ex.Message}", Severity.Error);
        }
    }

}